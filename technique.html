<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Technique Astro</title>
</head>

<body>

<h2>Calcul Placidus — Technique</h2>

<p>Entrez vos données :</p>

<label>Latitude (ex : 46° 06' N) :</label><br>
<input id="lat" type="text" value="46° 06' N"><br><br>

<label>Longitude (ex : 0h 12m 48s E) :</label><br>
<input id="lon" type="text" value="0h 12m 48s E"><br><br>

<label>Date (AAAA-MM-JJ) :</label><br>
<input id="date" type="date" value="1962-01-29"><br><br>

<label>Heure légale (HH:MM) :</label><br>
<input id="time" type="time" value="19:30"><br><br>

<button onclick="runCalc()">Calculer</button>

<hr>

<h3>Résultat :</h3>
<pre id="output">Aucun calcul lancé.</pre>


<script>
/* =====================================================
         1. CONVERSION HEURE LEGALE → UT → HEURE LOCALE
   ===================================================== */

// Convertit "0h 12m 48s E" en secondes +/-
function parseLongitude(lon) {
    const m = lon.match(/(\d+)h (\d+)m (\d+)s (E|O)/);
    if (!m) return 0;

    let h = parseInt(m[1]);
    let mn = parseInt(m[2]);
    let s = parseInt(m[3]);
    const dir = m[4];

    let totalSeconds = h*3600 + mn*60 + s;
    if (dir === "O") totalSeconds = -totalSeconds;

    return totalSeconds;
}

// Décide automatiquement heure d’été/hiver (France)
function frenchOffset(dateObj) {
    const year = dateObj.getUTCFullYear();

    // Avant 1976 → UTC+1 toute l'année
    if (year < 1976) return -1;

    const month = dateObj.getUTCMonth() + 1;

    // Hiver
    if (month === 1 || month === 2 || month === 11 || month === 12) return -1;

    // Été
    if (month === 6 || month === 7 || month === 8) return -2;

    // Mi-saison
    return -1;
}

function timeToSeconds(t) {
    const [h,m] = t.split(":").map(x => parseInt(x));
    return h*3600 + m*60;
}

function secondsToHMS(sec) {
    sec = (sec % 86400 + 86400) % 86400;
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = Math.floor(sec%60);
    return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}


/* =====================================================
                 2. CODE PLACIDUS (réparé)
   ===================================================== */

function computeChart({ lat, lon, date, timeLocal }) {

    function toRad(d) { return d * Math.PI/180; }
    function toDeg(r) { return r * 180/Math.PI; }
    function normalize(a) { a = a % 360; return a < 0 ? a + 360 : a; }

    function dms(a) {
        const d = Math.floor(a);
        const m = Math.round((a-d)*60);
        return `${d}°${m<10?"0":""}${m}'`;
    }

    const signs = [
        "♈ Bélier","♉ Taureau","♊ Gémeaux","♋ Cancer","♌ Lion","♍ Vierge",
        "♎ Balance","♏ Scorpion","♐ Sagittaire","♑ Capricorne","♒ Verseau","♓ Poissons"
    ];
    function signOf(a) { return signs[Math.floor(a/30)]; }

    const latMatch = lat.match(/(\d+)° (\d+)' (N|S)/);
    const φ = (latMatch[3]==="N" ? 1 : -1) *
              (parseInt(latMatch[1]) + parseInt(latMatch[2])/60);

    // --- TEMPS LOCAL DÉJÀ CALCULÉ ---
    const dt = new Date(`${date}T${timeLocal}`);
    const JD = dt.getTime()/86400000 + 2440587.5;
    const T = (JD - 2451545.0)/36525;

    let GMST = 280.46061837 +
               360.98564736629*(JD - 2451545) +
               0.000387933*T*T -
               (T*T*T)/38710000;

    GMST = normalize(GMST);

    // Longitude EN HEURES est déjà incluse dans timeLocal → NE PAS ajouter ici
    const LST = normalize(GMST);

    const ε = toRad(23.439291);

    // --- MC ---
    const MC_rad = Math.atan2(Math.tan(toRad(LST)), Math.cos(ε));
    let MC = normalize(toDeg(MC_rad));
    if (Math.cos(toRad(LST)) < 0) MC = normalize(MC + 180);

    // --- ASC ---
    const φ_rad = toRad(φ);

    const asc_rad =
        Math.atan2(
            -Math.cos(ε)*Math.tan(φ_rad) - Math.sin(ε)*Math.sin(toRad(LST)),
            Math.cos(toRad(LST))
        );

    const ASC = normalize(toDeg(asc_rad));


    function placidusHouse(target) {
        let hTarget =
            target===2 ? LST+30 :
            target===3 ? LST+60 :
            target===5 ? LST+120 : LST+150;

        hTarget = normalize(hTarget);

        let H = toRad(hTarget), prev;

        for (let i=0; i<15; i++) {
            prev = H;
            H = Math.atan2(
                Math.sin(prev),
                Math.cos(prev)*Math.cos(ε) - Math.tan(φ_rad)*Math.sin(ε)
            );
            if (Math.abs(H-prev)<1e-7) break;
        }
        return normalize(toDeg(H));
    }

    return {
        asc: {deg:ASC, txt:dms(ASC), sign:signOf(ASC)},
        mc:  {deg:MC,  txt:dms(MC),  sign:signOf(MC)},
        h2:  {deg:placidusHouse(2), txt:dms(placidusHouse(2)), sign:signOf(placidusHouse(2))},
        h3:  {deg:placidusHouse(3), txt:dms(placidusHouse(3)), sign:signOf(placidusHouse(3))},
        h5:  {deg:placidusHouse(5), txt:dms(placidusHouse(5)), sign:signOf(placidusHouse(5))},
        h6:  {deg:placidusHouse(6), txt:dms(placidusHouse(6)), sign:signOf(placidusHouse(6))}
    };
}


/* =====================================================
                 3. APPEL FINAL
   ===================================================== */

function runCalc() {

    const lat  = document.getElementById("lat").value;
    const lon  = document.getElementById("lon").value;
    const date = document.getElementById("date").value;
    const timeLegal = document.getElementById("time").value;

    const dtLegal = new Date(`${date}T${timeLegal}:00`);

    const offset = frenchOffset(dtLegal);   // -1 ou -2
    const legalSeconds = timeToSeconds(timeLegal);

    const utSeconds = legalSeconds + offset*3600;

    const lonSeconds = parseLongitude(lon);

    const localSeconds = utSeconds + lonSeconds;

    const timeLocal = secondsToHMS(localSeconds);

    const result = computeChart({
        lat,
        lon,
        date,
        timeLocal
    });

    document.getElementById("output").textContent =
        JSON.stringify(result, null, 2);
}
</script>

</body>
</html>
