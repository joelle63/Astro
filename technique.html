<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Technique Astro – Placidus PRO</title>
</head>

<body>

<h2>Calcul Placidus — Version PRO Exacte</h2>

<label>Latitude (ex : 46° 06' N) :</label><br>
<input id="lat" type="text" value="46° 06' N"><br><br>

<label>Longitude (ex : 0h 12m 48s E) :</label><br>
<input id="lon" type="text" value="0h 12m 48s E"><br><br>

<label>Date (AAAA-MM-JJ) :</label><br>
<input id="date" type="date" value="1962-01-29"><br><br>

<label>Heure légale (HH:MM) :</label><br>
<input id="time" type="time" value="19:30"><br><br>

<button onclick="runCalc()">Calculer</button>

<hr>

<h3>Diagnostics :</h3>
<pre id="debug">Aucun calcul.</pre>

<h3>Résultats :</h3>
<pre id="output">Aucun calcul.</pre>

<script>
/* =========================================================================
   1. OUTILS DE BASE : CONVERSIONS HEURES / LONGITUDE / SECONDES
   ========================================================================= */

function parseLongitude(lon) {
    const m = lon.match(/(\d+)h (\d+)m (\d+)s (E|O)/);
    if (!m) return 0;
    let sec = (+m[1])*3600 + (+m[2])*60 + (+m[3]);
    if (m[4] === "O") sec = -sec;
    return sec;
}

function frenchOffset(dateObj) {
    const y = dateObj.getUTCFullYear();
    if (y < 1976) return -1;  // UTC+1 toute l’année avant 1976
    const m = dateObj.getUTCMonth()+1;
    if ([11,12,1,2].includes(m)) return -1;
    if ([6,7,8].includes(m)) return -2;
    return -1;
}

function timeToSeconds(t) {
    const [H,M] = t.split(":").map(x=>parseInt(x));
    return H*3600 + M*60;
}

function secondsToHMS(sec) {
    sec = (sec % 86400 + 86400) % 86400;
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = Math.floor(sec%60);
    return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

/* =========================================================================
   2. TEMPS SIDÉRAL — FORMULE ASTROLOGIQUE PRO
   (donne TS0 = 08:31:03 pour 1962-01-29)
   ========================================================================= */

function gmstAstrologique(JD_ut, ut_seconds) {
    const JD0 = Math.floor(JD_ut - 0.5) + 0.5;
    const T = (JD0 - 2451545.0) / 36525;

    // GMST0 en secondes
    let GMST0 =
        24110.54841 +
        8640184.812866*T +
        0.093104*T*T -
        0.0000062*T*T*T;

    // GMST = GMST0 + UT * rotation terrestre
    let GMST = GMST0 + 1.00273790935 * ut_seconds;

    GMST0 = (GMST0 % 86400 + 86400) % 86400;
    GMST = (GMST % 86400 + 86400) % 86400;

    return {GMST, GMST0, JD0};
}

/* =========================================================================
   3. PLACIDUS PRO EXACT — ALGORITHME PROFESSIONNEL
   ========================================================================= */

function placidusCusps(LST_deg, lat_deg, eps_rad) {

    const toRad = d => d*Math.PI/180;
    const toDeg = r => r*180/Math.PI;

    const φ = toRad(lat_deg);
    const θ = toRad(LST_deg);

    function ascRa() {
        const A = Math.atan2(
            -Math.cos(eps_rad)*Math.tan(φ) - Math.sin(eps_rad)*Math.sin(θ),
            Math.cos(θ)
        );
        return (toDeg(A)+360)%360;
    }

    const ASC = ascRa();
    const DSC = (ASC + 180) % 360;

    /* ------------- Demi-arcs ------------- */

    function semiArc(dec) {
        return Math.acos(-Math.tan(φ)*Math.tan(dec));
    }

    /* ------------- Placidus RAO solver ------------- */

    function RAtoEclLongitude(RA) {
        // transforme une ascension droite en longitude écliptique
        const dec = Math.asin(Math.sin(eps_rad)*Math.sin(RA));
        const y = Math.sin(RA)*Math.cos(eps_rad);
        const x = Math.cos(RA);
        let λ = Math.atan2(y,x);
        return ((toDeg(λ)+360)%360);
    }

    function cuspHouse(n, RA_MC) {

        const angle = {
            11: RA_MC + Math.PI/6,
            12: RA_MC + Math.PI/3,
            2:  RA_MC - Math.PI/3,
            3:  RA_MC - Math.PI/6
        }[n];

        const A = angle;

        let RA = A;
        for (let i=0;i<30;i++) {
            const dec = Math.asin(Math.sin(eps_rad)*Math.sin(RA));
            const SA = semiArc(dec);
            const target = (n===11||n===12) ? SA/3 : -SA/3;

            const f = RA_MC - RA + target;
            RA = RA + f;
        }

        return (RA+2*Math.PI)%(2*Math.PI);
    }

    const RA_MC = θ;

    const cusp11 = cuspHouse(11, RA_MC);
    const cusp12 = cuspHouse(12, RA_MC);
    const cusp2  = cuspHouse(2, RA_MC);
    const cusp3  = cuspHouse(3, RA_MC);

    return {
        ASC,
        MC: LST_deg,
        cusp11: RAtoEclLongitude(cusp11),
        cusp12: RAtoEclLongitude(cusp12),
        cusp2:  RAtoEclLongitude(cusp2),
        cusp3:  RAtoEclLongitude(cusp3)
    };
}

/* =========================================================================
   4. CALCUL COMPLET (ASC, MC, MAISONS PRO)
   ========================================================================= */

function computeChart({lat, lon, date, timeLocal, ut_seconds}) {

    function norm(a){a=a%360;return a<0?a+360:a;}

    const latM = lat.match(/(\d+)° (\d+)' (N|S)/);
    const φ = (latM[3]=="N"?1:-1)*(+latM[1] + (+latM[2]/60));

    const dt = new Date(`${date}T${timeLocal}`);
    const JD = dt.getTime()/86400000 + 2440587.5;

    const {GMST, GMST0, JD0} = gmstAstrologique(JD, ut_seconds);

    const lon_sec = parseLongitude(lon);
    const LST_sec = (GMST + lon_sec + 86400) % 86400;
    const LST = LST_sec/86400*360;

    const eps = 23.439291 * Math.PI/180;

    /* ASC, MC, CUSPIDES */
    const houses = placidusCusps(LST, φ, eps);

    return {
        TS0 : secondsToHMS(GMST0),
        GMST: secondsToHMS(GMST),
        LST : secondsToHMS(LST_sec),

        asc: houses.ASC,
        mc : houses.MC,
        h11: houses.cusp11,
        h12: houses.cusp12,
        h2 : houses.cusp2,
        h3 : houses.cusp3
    };
}

/* =========================================================================
   5. RUN + DEBUG
   ========================================================================= */

function runCalc(){
    const lat=document.getElementById("lat").value;
    const lon=document.getElementById("lon").value;
    const date=document.getElementById("date").value;
    const timeLegal=document.getElementById("time").value;

    const dtL = new Date(`${date}T${timeLegal}:00`);
    const offset = frenchOffset(dtL);
    const legal_seconds = timeToSeconds(timeLegal);
    const ut_seconds = legal_seconds + offset*3600;

    const lon_seconds = parseLongitude(lon);
    const local_seconds = ut_seconds + lon_seconds;

    const timeLocal = secondsToHMS(local_seconds);

    const r = computeChart({
        lat, lon, date, timeLocal, ut_seconds
    });

    document.getElementById("debug").textContent =
`Heure légale  : ${timeLegal}
UT            : ${secondsToHMS(ut_seconds)}
Longitude     : ${secondsToHMS(lon_seconds)}
Heure locale  : ${timeLocal}

TS à minuit   : ${r.TS0}
GMST instant  : ${r.GMST}
LST (naiss.)  : ${r.LST}
`;

    document.getElementById("output").textContent =
`ASC  : ${r.asc}°
MC   : ${r.mc}°

Maison 11 : ${r.h11}°
Maison 12 : ${r.h12}°
Maison 2  : ${r.h2}°
Maison 3  : ${r.h3}°
`;
}
</script>

</body>
</html>

