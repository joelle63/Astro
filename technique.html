<script>
function chercherVille() {
    const ville = document.getElementById("ville").value.trim();
    if (!ville) return;

    const url = "https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(ville);

    fetch(url).then(res => res.json()).then(data => {
        if (!data.length) { alert("Ville introuvable."); return; }

        const latitude = parseFloat(data[0].lat);
        const longitude = parseFloat(data[0].lon);

        const lat_deg = Math.floor(Math.abs(latitude));
        const lat_min = Math.round((Math.abs(latitude) - lat_deg) * 60);
        const lat_txt = lat_deg + "° " + lat_min + "' " + (latitude >= 0 ? "N" : "S");

        const total_seconds = Math.abs(longitude) * 240;
        const long_h = Math.floor(total_seconds / 3600);
        const long_m = Math.floor((total_seconds % 3600) / 60);
        const long_s = Math.round(total_seconds % 60);
        const long_txt = long_h + "h " + long_m + "m " + long_s + "s " + (longitude >= 0 ? "E" : "O");

        document.getElementById("lat").textContent = lat_txt;
        document.getElementById("lon").textContent = long_txt;
    });
}

function calculHeures() {
    const date = document.getElementById("dateNaissance").value;
    const heure = document.getElementById("heureNaissance").value;
    const lonTxt = document.getElementById("lon").textContent;

    if (!date || !heure || lonTxt === "—") return;

    // Conversion en Date
    const datetime = new Date(date + "T" + heure + ":00");

    // Heure GMT
    const gmt_h = ("0" + datetime.getUTCHours()).slice(-2);
    const gmt_m = ("0" + datetime.getUTCMinutes()).slice(-2);
    document.getElementById("heure_gtm").textContent = gmt_h + ":" + gmt_m;

    // Extraire longitude formatée
    const match = lonTxt.match(/(\\d+)h (\\d+)m (\\d+)s (E|O)/);
    if (!match) return;

    const h = parseInt(match[1]);
    const m = parseInt(match[2]);
    const s = parseInt(match[3]);
    const sign = match[4] === "E" ? 1 : -1;

    // Conversion longitude -> degrés
    const longitude_deg = sign * (h * 15 + m * 0.25 + s / 240);

    // Décalage en secondes (1° = 4 minutes = 240s)
    const offset_sec = longitude_deg * 240;

    // Heure locale vraie (LMT)
    const lmt = new Date(datetime.getTime() + offset_sec * 1000);
    const l_h = ("0" + lmt.getUTCHours()).slice(-2);
    const l_m = ("0" + lmt.getUTCMinutes()).slice(-2);
    const l_s = ("0" + lmt.getUTCSeconds()).slice(-2);

    document.getElementById("heure_locale").textContent = l_h + ":" + l_m + ":" + l_s;
}
</script>

